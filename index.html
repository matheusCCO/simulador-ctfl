<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Simulado CTFL - Quiz</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    .k1 { background-color: #c7ccfe; }
    .k2 { background-color: #bffec2; }
    .k3 { background-color: #fcefa5; }
    .k4 { background-color: #fa9d9d; }
  </style>
</head>
<body class="bg-gray-100 p-4">
  <div class="max-w-4xl mx-auto bg-white shadow-lg rounded-lg p-6">
    <h1 class="text-2xl font-bold mb-4">Simulado CTFL v4.0 - Exame Oficial ISTQB</h1>
    <div class="mb-4 p-3 bg-green-100 border border-green-400 rounded">
      <p class="text-sm"><strong>✅ Questões Oficiais:</strong> O Exame A contém as 40 questões oficiais extraídas do PDF do ISTQB CTFL v4.0. Os demais exames contêm questões de exemplo para prática adicional.</p>
    </div>

    <div class="mb-4">
      <label for="examSelect" class="block font-semibold">Escolha o simulado:</label>
      <div class="flex gap-2 items-center">
        <select id="examSelect" class="border p-2 rounded w-full transition-colors focus:ring-2 focus:ring-blue-400 focus:border-blue-400">
          <option value="examA">Exame A (Oficial ISTQB)</option>
        </select>
        <input type="file" id="importJson" accept="application/json" class="hidden" />
        <button id="importBtn" type="button" class="bg-blue-100 border border-blue-400 px-3 py-2 rounded hover:bg-blue-200 text-sm font-semibold transition-colors">Importar JSON</button>
      </div>
    </div>

    <button onclick="startQuiz()" class="bg-blue-600 text-white px-4 py-2 rounded">Iniciar Quiz</button>

    <div id="quiz" class="mt-6 hidden">
      <div id="timer" class="text-right font-bold text-red-500">Tempo: 60:00</div>
      <div id="questionContainer" class="mt-4"></div>
      <button onclick="submitQuiz()" class="bg-green-600 text-white px-4 py-2 rounded mt-4">Finalizar Tentativa</button>
    </div>

    <div id="result" class="mt-6 hidden"></div>
    <div id="history" class="mt-6">
      <h2 class="text-xl font-bold mb-2">Histórico de Tentativas</h2>
      <ul id="historyList" class="list-disc pl-5"></ul>
    </div>
  </div>

  <script>
    let currentQuestions = [];
    let timer;
    let remainingTime = 60 * 60;
    let simulados = {
      examA: {
        nome: 'Exame A (Oficial ISTQB)',
        arquivo: 'SimuladoA.json',
        questoes: null,
        importado: false
      }
    };

    async function startQuiz() {
      const selected = document.getElementById("examSelect").value;
      let simulado = simulados[selected];
      if (!simulado) {
        alert('Simulado não encontrado.');
        return;
      }
      if (simulado.importado) {
        // Simulado importado já está em memória
        currentQuestions = simulado.questoes;
      } else {
        // Simulado local, carrega do arquivo se necessário
        if (simulado.questoes) {
          currentQuestions = simulado.questoes;
        } else {
          try {
            const response = await fetch(simulado.arquivo);
            if (!response.ok) throw new Error('Erro ao carregar ' + simulado.arquivo);
            const data = await response.json();
            if (Array.isArray(data)) {
              currentQuestions = data;
            } else if (Array.isArray(data.questoes)) {
              currentQuestions = data.questoes;
            } else {
              currentQuestions = [];
            }
            simulados[selected].questoes = currentQuestions;
          } catch (e) {
            alert('Erro ao carregar questões do simulado: ' + e.message);
            return;
          }
        }
      }
      if (!currentQuestions || currentQuestions.length === 0) {
        alert("Esse exame ainda não tem questões disponíveis.");
        return;
      }
      document.getElementById("quiz").classList.remove("hidden");
      document.getElementById("result").classList.add("hidden");
      renderQuestions();
      startTimer();
    }

    // Importação de JSON para cadastrar novos simulados
    document.addEventListener('DOMContentLoaded', () => {
      const importBtn = document.getElementById('importBtn');
      const importInput = document.getElementById('importJson');
      const examSelect = document.getElementById('examSelect');
      importBtn.addEventListener('click', () => importInput.click());
      importInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(ev) {
          try {
            const data = JSON.parse(ev.target.result);
            let questoes = Array.isArray(data) ? data : data.questoes;
            if (!Array.isArray(questoes) || !questoes.length) throw new Error('Arquivo sem questões válidas.');
            // Gera id único
            const id = 'simulado_' + Date.now();
            simulados[id] = {
              nome: file.name.replace(/\.json$/i, ''),
              arquivo: null,
              questoes,
              importado: true
            };
            // Adiciona ao select
            const opt = document.createElement('option');
            opt.value = id;
            opt.textContent = simulados[id].nome + ' (importado)';
            opt.className = 'bg-blue-50 text-blue-900 font-semibold';
            examSelect.appendChild(opt);
            examSelect.value = id;
            alert('Simulado importado com sucesso!');
          } catch (err) {
            alert('Erro ao importar JSON: ' + err.message);
          }
        };
        reader.readAsText(file);
        // Limpa input para permitir importar o mesmo arquivo novamente se quiser
        e.target.value = '';
      });
      // Ao trocar o select, limpa quiz/result e prepara para novo simulado
      examSelect.addEventListener('change', () => {
        document.getElementById("quiz").classList.add("hidden");
        document.getElementById("result").classList.add("hidden");
      });
    });

    function renderQuestions() {
      const container = document.getElementById("questionContainer");
      container.innerHTML = "";
      currentQuestions.forEach((q, i) => {
        const qDiv = document.createElement("div");
        const level = (q.level || q.nivel || '').toUpperCase();
        qDiv.className = `mb-4 p-4 rounded bg-gray-50 ${level ? 'k'+level[1] : ''}`;
        // Suporte a diferentes formatos de questão
        const texto = q.questao || q.questão || q.question || '';
        // Suporte a alternativas como objeto (A,B,C,...) ou array
        let alternativas = [];
        let letras = [];
        if (Array.isArray(q.alternativas)) {
          alternativas = q.alternativas;
          letras = alternativas.map((_, idx) => String.fromCharCode(65 + idx));
        } else if (q.alternativas && typeof q.alternativas === 'object') {
          letras = Object.keys(q.alternativas);
          alternativas = letras.map(letra => q.alternativas[letra]);
        } else if (Array.isArray(q.options)) {
          alternativas = q.options;
          letras = alternativas.map((_, idx) => String.fromCharCode(65 + idx));
        }
        const isCheckbox = (q.tipo && q.tipo.toLowerCase().includes('checkbox')) || q.multiple === true;
        let html = `<p class="font-semibold flex items-center gap-2">${i + 1}. ${texto} `;
        if (level) {
          html += `<span class="inline-block align-middle text-xs font-bold px-2 py-1 rounded-full border border-gray-400 shadow-sm ml-2 ${level ? 'k'+level[1] : ''}" style="min-width:2.5em;text-align:center;">${level}</span>`;
        }
        html += `</p>`;
        if (Array.isArray(q.imagens) && q.imagens.length > 0) {
          html += '<div class="flex flex-col items-center">';
          q.imagens.forEach(img => {
            html += `<img src="${img}" alt="Imagem da questão" class="mt-2" style="width:500px;max-width:100%;height:auto;" />`;
          });
          html += '</div>';
        }
        if (isCheckbox) {
          html += letras.map((letra, j) => `
            <label class="block mt-2 cursor-pointer">
              <input type="checkbox" name="q${i}" value="${letra}" class="mr-2" /> <span class="font-mono">${letra}</span>) ${alternativas[j]}
            </label>
          `).join("");
        } else {
          html += letras.map((letra, j) => `
            <label class="block mt-2 cursor-pointer">
              <input type="radio" name="q${i}" value="${letra}" class="mr-2" /> <span class="font-mono">${letra}</span>) ${alternativas[j]}
            </label>
          `).join("");
        }
        qDiv.innerHTML = html;
        container.appendChild(qDiv);
      });
    }

    function startTimer() {
      remainingTime = 60 * 60;
      updateTimer();
      timer = setInterval(() => {
        remainingTime--;
        updateTimer();
        if (remainingTime <= 0) {
          clearInterval(timer);
          alert("Tempo esgotado!");
          submitQuiz();
        }
      }, 1000);
    }

    function updateTimer() {
      const min = Math.floor(remainingTime / 60).toString().padStart(2, '0');
      const sec = (remainingTime % 60).toString().padStart(2, '0');
      document.getElementById("timer").textContent = `Tempo: ${min}:${sec}`;
    }


    function submitQuiz() {
      clearInterval(timer);
      let acertos = 0;
      let total = currentQuestions.length;
      let html = '';
      currentQuestions.forEach((q, i) => {
        const userAnswers = Array.from(document.querySelectorAll(`[name='q${i}']:checked`)).map(el => el.value);
        let correta = q.correta || q.answer;
        let isCheckbox = (q.tipo && q.tipo.toLowerCase().includes('checkbox')) || q.multiple === true;
        // Corrige formato da resposta correta
        let corretaArr = [];
        if (Array.isArray(correta)) {
          corretaArr = correta.map(String);
        } else if (typeof correta === 'string' && correta.includes(',')) {
          corretaArr = correta.split(',').map(s => s.trim());
        } else if (typeof correta === 'string') {
          corretaArr = [correta.trim()];
        } else if (typeof correta === 'number') {
          corretaArr = [String(correta)];
        }
        // Verifica se acertou
        let acertou = false;
        if (isCheckbox) {
          acertou = userAnswers.length === corretaArr.length && userAnswers.every(a => corretaArr.includes(a));
        } else {
          acertou = userAnswers.length === 1 && corretaArr.includes(userAnswers[0]);
        }
        if (acertou) acertos++;
        // Renderiza resultado da questão
        const level = (q.level || q.nivel || '').toUpperCase();
        html += `<div class="mb-4 p-4 rounded bg-gray-50 border ${acertou ? 'border-green-400 bg-green-50' : 'border-red-400 bg-red-50'}">`;
        html += `<p class="font-semibold flex items-center gap-2">${i + 1}. ${(q.questao || q.questão || q.question || '')}`;
        if (level) {
          html += `<span class="inline-block align-middle text-xs font-bold px-2 py-1 rounded-full border bg-Se border-gray-400 shadow-sm ml-2 ${level ? 'k'+level[1] : ''}" style="min-width:2.5em;text-align:center;">${level}</span>`;
        }
        html += `</p>`;
        if (Array.isArray(q.imagens) && q.imagens.length > 0) {
          html += '<div class="flex flex-col items-center">';
          q.imagens.forEach(img => {
            html += `<img src="${img}" alt="Imagem da questão" class="mt-2" style="width:500px;max-width:100%;height:auto;" />`;
          });
          html += '</div>';
        }
        html += `<div class="mt-2">Sua resposta: <span class="font-mono">${userAnswers.join(', ') || '-'}</span></div>`;
        html += `<div class="mt-1">Correta: <span class="font-mono">${corretaArr.join(', ')}</span></div>`;
        html += acertou ? `<div class="text-green-700 font-bold">✔ Acertou</div>` : `<div class="text-red-700 font-bold">✘ Errou</div>`;
        html += `</div>`;
      });
      const nota = Math.round((acertos / total) * 100);
      const erros = total - acertos;
      const aprovado = nota >= 65;
      // Salva histórico no localStorage
      const tentativa = {
        data: new Date().toLocaleString(),
        nota,
        acertos,
        erros,
        total,
        aprovado
      };
      let historico = [];
      try {
        historico = JSON.parse(localStorage.getItem('ctfl_historico') || '[]');
      } catch {}
      historico.unshift(tentativa);
      localStorage.setItem('ctfl_historico', JSON.stringify(historico.slice(0, 10)));
      renderHistory();
      // Alerta de aprovação
      setTimeout(() => {
        alert(`${aprovado ? '✅ Parabéns, você foi APROVADO!' : '❌ Você NÃO foi aprovado.'}\n\nAcertos: ${acertos}\nErros: ${erros}\nNota: ${nota}%`);
      }, 100);
      html = `<div class="mb-4 text-lg font-bold">Nota: ${nota}% (${acertos} acertos, ${erros} erros de ${total} questões) - ${aprovado ? '<span class=\'text-green-700\'>APROVADO</span>' : '<span class=\'text-red-700\'>REPROVADO</span>'}</div>` + html;
      document.getElementById("result").innerHTML = html;
      document.getElementById("result").classList.remove("hidden");
      document.getElementById("quiz").classList.add("hidden");
    }

    function renderHistory() {
      let historico = [];
      try {
        historico = JSON.parse(localStorage.getItem('ctfl_historico') || '[]');
      } catch {}
      const ul = document.getElementById('historyList');
      if (!ul) return;
      ul.innerHTML = '';
      if (!historico.length) {
        ul.innerHTML = '<li class="text-gray-500">Nenhuma tentativa registrada ainda.</li>';
        return;
      }
      historico.forEach((t, idx) => {
        ul.innerHTML += `<li class="mb-1">${t.data}: <b>${t.nota}%</b> (${t.acertos} acertos, ${t.erros} erros) - ${t.aprovado ? '<span class=\'text-green-700\'>APROVADO</span>' : '<span class=\'text-red-700\'>REPROVADO</span>'}</li>`;
      });
    }

    // Renderiza histórico ao carregar página
    window.addEventListener('DOMContentLoaded', renderHistory);

  </script>
  </body>
</html>
